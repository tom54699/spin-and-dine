<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>今天吃什麼？</title>
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --accent: #f97316;
      --accent-dark: #ea580c;
      --border: #e2e8f0;
      --shadow: 0 12px 40px rgba(15, 23, 42, 0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", "Noto Sans TC", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, #fff7ed, #f8fafc 45%),
                  radial-gradient(circle at 80% 10%, #e0f2fe, #f8fafc 35%),
                  radial-gradient(circle at 60% 80%, #fef2f2, #f8fafc 40%);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      position: sticky;
      top: 0;
      background: rgba(248, 250, 252, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      z-index: 10;
    }
    h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.3px;
    }
    nav {
      display: grid;
      grid-auto-flow: column;
      gap: 8px;
    }
    button.tab {
      border: 1px solid var(--border);
      background: var(--card);
      padding: 10px 14px;
      border-radius: 12px;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 14px rgba(15, 23, 42, 0.06);
    }
    button.tab.active {
      color: var(--text);
      border-color: #fed7aa;
      background: linear-gradient(135deg, #fff7ed, #ffe4e6);
      box-shadow: 0 10px 24px rgba(249, 115, 22, 0.16);
    }
    main {
      padding: 24px;
      display: grid;
      gap: 24px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 20px;
      box-shadow: var(--shadow);
    }
    .spinner-wrap {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 18px;
      align-items: center;
    }
    .wheel {
      width: min(480px, 80vw);
      aspect-ratio: 1;
      border-radius: 50%;
      border: 10px solid #fff;
      box-shadow: 0 20px 40px rgba(0,0,0,0.12);
      position: relative;
      margin: auto;
      overflow: hidden;
      background: #fff;
    }
    .wheel canvas { width: 100%; height: 100%; display: block; }
    .pointer {
      position: absolute;
      top: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 16px solid transparent;
      border-right: 16px solid transparent;
      border-bottom: 22px solid var(--accent);
      filter: drop-shadow(0 6px 10px rgba(0,0,0,0.2));
      z-index: 2;
    }
    .controls { display: grid; gap: 12px; }
    .controls label { color: var(--muted); font-size: 14px; }
    .controls select, .controls input, .controls button, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-size: 15px;
    }
    .primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      border: none;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s ease;
    }
    .primary:active { transform: translateY(1px); }
    .list { width: 100%; border-collapse: collapse; }
    .list th, .list td {
      padding: 10px 8px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      font-size: 14px;
    }
    .list th { color: var(--muted); font-weight: 600; }
    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: #f1f5f9;
      color: var(--muted);
      font-size: 12px;
    }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .toast {
      position: fixed;
      bottom: 18px;
      right: 18px;
      padding: 12px 16px;
      border-radius: 12px;
      background: #0f172a;
      color: white;
      box-shadow: var(--shadow);
      opacity: 0;
      transform: translateY(8px);
      transition: all 0.25s ease;
      z-index: 50;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .hidden { display: none; }
    @media (max-width: 900px) {
      .spinner-wrap { grid-template-columns: 1fr; }
      header { flex-direction: column; align-items: flex-start; gap: 8px; }
      nav { width: 100%; grid-auto-flow: row; grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
  </style>
</head>
<body>
  <header>
    <h1>今天吃什麼？</h1>
    <nav>
      <button class="tab active" data-tab="wheel">轉盤</button>
      <button class="tab" data-tab="list">餐廳名單</button>
    </nav>
  </header>

  <main>
    <section id="wheel" class="card">
      <div class="spinner-wrap">
        <div class="wheel" id="wheelBox">
          <div class="pointer"></div>
          <canvas id="wheelCanvas"></canvas>
        </div>
        <div class="controls">
          <div>
            <label for="filter">排除規則</label>
            <select id="filter">
              <option value="none">不排除</option>
              <option value="7">排除 7 天內吃過</option>
              <option value="30">排除 30 天內吃過</option>
            </select>
          </div>
          <button class="primary" id="spinBtn">開始轉</button>
          <div id="picked" class="pill hidden"></div>
          <p class="pill" id="stat">準備中...</p>
        </div>
      </div>
    </section>

    <section id="list" class="card hidden">
      <h2 style="margin-top:0">餐廳名單</h2>
      <div class="controls" style="grid-template-columns: 1fr 160px; align-items:end; gap:12px;">
        <div>
          <label>餐廳名稱</label>
          <input id="nameInput" placeholder="例如：阿明炒飯" />
        </div>
        <button class="primary" id="addBtn">新增</button>
      </div>
      <div class="actions" style="margin:12px 0 8px;">
        <button id="exportBtn">匯出 JSON</button>
        <label style="display:flex; gap:6px; align-items:center; cursor:pointer;">
          <input type="file" id="importFile" accept="application/json" style="display:none" />
          <span class="pill" id="importLabel">匯入 JSON</span>
        </label>
      </div>
      <table class="list" id="table">
        <thead>
          <tr>
            <th style="width:45%">名稱</th>
            <th style="width:30%">最後吃到</th>
            <th style="width:25%">操作</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>
  </main>

  <div class="toast" id="toast"></div>

  <script>
    const storageKey = 'lunch-places-v1';
    const state = {
      places: loadPlaces(),
      spinning: false,
      currentAngle: 0,
      animationId: null
    };

    const canvas = document.getElementById('wheelCanvas');
    const ctx = canvas.getContext('2d');
    const spinBtn = document.getElementById('spinBtn');
    const filterSel = document.getElementById('filter');
    const pickedEl = document.getElementById('picked');
    const statEl = document.getElementById('stat');
    const nameInput = document.getElementById('nameInput');
    const addBtn = document.getElementById('addBtn');
    const tbody = document.getElementById('tbody');
    const exportBtn = document.getElementById('exportBtn');
    const importFile = document.getElementById('importFile');
    const importLabel = document.getElementById('importLabel');

    const tabs = document.querySelectorAll('.tab');
    const sections = { wheel: document.getElementById('wheel'), list: document.getElementById('list') };

    init();

    function init() {
      resizeCanvas();
      drawWheel();
      renderTable();
      updateStats();
      window.addEventListener('resize', () => { resizeCanvas(); drawWheel(); });
      tabs.forEach(btn => btn.addEventListener('click', handleTab));
      spinBtn.addEventListener('click', spin);
      filterSel.addEventListener('change', () => { drawWheel(); updateStats(); });
      addBtn.addEventListener('click', addPlace);
      exportBtn.addEventListener('click', exportData);
      importLabel.addEventListener('click', () => importFile.click());
      importFile.addEventListener('change', importData);
    }

    function loadPlaces() {
      try {
        const raw = localStorage.getItem(storageKey);
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.warn('讀取失敗，改用空名單', e);
        return [];
      }
    }

    function persist() {
      localStorage.setItem(storageKey, JSON.stringify(state.places));
    }

    function handleTab(e) {
      const tab = e.target.dataset.tab;
      tabs.forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
      Object.entries(sections).forEach(([key, el]) => {
        el.classList.toggle('hidden', key !== tab);
      });
    }

    function resizeCanvas() {
      const box = document.getElementById('wheelBox');
      const size = box.clientWidth;
      canvas.width = size;
      canvas.height = size;
    }

    function drawWheel() {
      const places = filteredPlaces();
      const count = places.length || 1;
      const radius = canvas.width / 2;
      ctx.clearRect(0,0,canvas.width, canvas.height);
      ctx.save();
      ctx.translate(radius, radius);
      const colors = ['#f97316','#fb7185','#38bdf8','#22c55e','#a855f7','#f59e0b','#14b8a6'];
      for (let i = 0; i < count; i++) {
        const angleStart = (i / count) * 2 * Math.PI + state.currentAngle;
        const angleEnd = ((i + 1) / count) * 2 * Math.PI + state.currentAngle;
        ctx.beginPath();
        ctx.moveTo(0,0);
        ctx.arc(0,0,radius, angleStart, angleEnd);
        ctx.fillStyle = colors[i % colors.length];
        ctx.fill();
        ctx.save();
        ctx.rotate((angleStart + angleEnd)/2);
        ctx.textAlign = 'right';
        ctx.fillStyle = '#fff';
        ctx.font = `${Math.max(14, radius/12)}px sans-serif`;
        ctx.fillText(places[i]?.name || '請新增餐廳', radius - 18, 6);
        ctx.restore();
      }
      ctx.restore();
    }

    function filteredPlaces() {
      const days = filterSel.value === 'none' ? 0 : Number(filterSel.value);
      if (!days) return state.places;
      const cutoff = Date.now() - days * 86400000;
      return state.places.filter(p => !p.last || new Date(p.last).getTime() < cutoff);
    }

    function spin() {
      const list = filteredPlaces();
      if (!list.length) {
        toast('名單符合條件的餐廳為空，先新增或調整排除規則。');
        return;
      }
      if (state.spinning) return;
      state.spinning = true;
      const duration = 3000 + Math.random() * 1500;
      const finalAngle = state.currentAngle + Math.PI * 6 + Math.random() * Math.PI * 4;
      const start = performance.now();

      function animate(now) {
        const progress = Math.min(1, (now - start) / duration);
        const ease = 1 - Math.pow(1 - progress, 3);
        state.currentAngle = lerp(state.currentAngle, finalAngle, ease);
        drawWheel();
        if (progress < 1) {
          state.animationId = requestAnimationFrame(animate);
        } else {
          finishSpin(list, finalAngle);
        }
      }
      state.animationId = requestAnimationFrame(animate);
    }

    function lerp(a, b, t) { return a + (b - a) * t; }

    function finishSpin(list, angle) {
      const normAngle = ((angle % (2*Math.PI)) + 2*Math.PI) % (2*Math.PI);
      const slice = (2*Math.PI) / list.length;
      const index = Math.floor(((2*Math.PI - normAngle + Math.PI/2) % (2*Math.PI)) / slice);
      const picked = list[index];
      picked.last = new Date().toISOString();
      persist();
      renderTable();
      updateStats();
      pickedEl.textContent = `今天吃：${picked.name}`;
      pickedEl.classList.remove('hidden');
      toast(`選中了 ${picked.name}`);
      state.spinning = false;
    }

    function addPlace() {
      const name = nameInput.value.trim();
      if (!name) return toast('請輸入餐廳名稱');
      if (state.places.some(p => p.name === name)) return toast('已存在相同名稱');
      state.places.push({ name, last: null });
      nameInput.value = '';
      persist();
      drawWheel();
      renderTable();
      updateStats();
      toast('已新增');
    }

    function removePlace(name) {
      state.places = state.places.filter(p => p.name !== name);
      persist();
      drawWheel();
      renderTable();
      updateStats();
      toast('已刪除');
    }

    function markToday(name) {
      const item = state.places.find(p => p.name === name);
      if (item) item.last = new Date().toISOString();
      persist();
      drawWheel();
      renderTable();
      updateStats();
      toast('已標記今天吃過');
    }

    function renderTable() {
      tbody.innerHTML = '';
      state.places.forEach(p => {
        const tr = document.createElement('tr');
        const last = p.last ? formatDate(p.last) : '—';
        tr.innerHTML = `
          <td>${p.name}</td>
          <td>${last}</td>
          <td>
            <div class="actions">
              <button onclick="markToday('${escapeAttr(p.name)}')">今天吃</button>
              <button onclick="removePlace('${escapeAttr(p.name)}')">刪除</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function updateStats() {
      const total = state.places.length;
      const filtered = filteredPlaces().length;
      statEl.textContent = `目前名單 ${filtered}/${total} 家符合規則`;
    }

    function formatDate(str) {
      const d = new Date(str);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function toast(msg) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      clearTimeout(el._timer);
      el._timer = setTimeout(() => el.classList.remove('show'), 2200);
    }

    function exportData() {
      const blob = new Blob([JSON.stringify(state.places, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'restaurants.json';
      a.click();
      URL.revokeObjectURL(a.href);
      toast('已匯出 JSON');
    }

    function importData(event) {
      const file = event.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);
          if (!Array.isArray(data)) throw new Error('格式不符');
          state.places = data.map(item => ({ name: String(item.name), last: item.last || null }));
          persist();
          drawWheel();
          renderTable();
          updateStats();
          toast('匯入成功');
        } catch (err) {
          toast('匯入失敗：' + err.message);
        }
        importFile.value = '';
      };
      reader.readAsText(file);
    }

    function escapeAttr(str) { return str.replace(/"/g, '&quot;').replace(/'/g, "&#39;"); }
  </script>
</body>
</html>
